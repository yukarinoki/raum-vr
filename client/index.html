<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <title>3D Chess (Raumschach) Frontend Sample with Captures</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }

    .board-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin: 20px 0;
    }

    .level {
      border: 1px solid #333;
      padding: 5px;
    }

    .level-title {
      font-weight: bold;
      margin-bottom: 5px;
      text-align: center;
    }

    .row {
      display: flex;
    }

    .square {
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #ccc;
      cursor: pointer;
      font-size: 14px;
      user-select: none;
    }

    .square:hover {
      background-color: #ffffe0;
    }

    .selected {
      background-color: yellow !important;
    }

    .possible-move {
      background-color: #90EE90 !important;
      /* 移動先候補の緑ハイライト */
    }

    .controls {
      margin-bottom: 10px;
    }
  </style>
</head>

<body>

  <h1>3D Chess (Raumschach) - Frontend Sample</h1>

  <div class="controls">
    <button id="new-game-btn">New Game</button>
    <button id="ai-move-btn">AI Move</button>
    <div>
      Game ID: <span id="game-id">-</span><br>
      Side to move: <span id="side-to-move">-</span>
    </div>
  </div>

  <!-- 追加: 駒の捕獲状況を表示する枠 -->
  <div>
    <h3>Captured Pieces</h3>
    <div>White captured: <span id="white-captured"></span></div>
    <div>Black captured: <span id="black-captured"></span></div>
  </div>

  <div class="board-container" id="board-container">
    <!-- レベル(A~E)を描画 -->
  </div>

  <script>
    const boardContainer = document.getElementById("board-container");
    const gameIdSpan = document.getElementById("game-id");
    const sideToMoveSpan = document.getElementById("side-to-move");

    // 新規: 捕獲状況表示要素
    const whiteCapturedSpan = document.getElementById("white-captured");
    const blackCapturedSpan = document.getElementById("black-captured");

    let gameId = null;
    let boardState = {};
    let sideToMove = "white";
    let selectedSquare = null;
    let possibleDestinations = [];

    // 追加: 現在の捕獲リスト (サーバーから渡される)
    let capturedPieces = {
      white: [],
      black: []
    };

    // FlaskサーバーのURL
    const SERVER_URL = "http://localhost:5001";

    document.getElementById("new-game-btn").addEventListener("click", newGame);
    document.getElementById("ai-move-btn").addEventListener("click", aiMove);

    async function newGame() {
      try {
        const res = await fetch(`${SERVER_URL}/new_game`, {
          method: "POST",
          headers: { "Content-Type": "application/json" }
        });
        const data = await res.json();
        if (data.game_id) {
          gameId = data.game_id;
          boardState = data.board;
          sideToMove = data.side_to_move;
          capturedPieces = data.captured_pieces ?? { white: [], black: [] };

          gameIdSpan.textContent = gameId;
          sideToMoveSpan.textContent = sideToMove;
          renderCapturedPieces();
          renderBoard();
        }
      } catch (err) {
        console.error(err);
        alert("Failed to start new game.");
      }
    }

    async function aiMove() {
      if (!gameId) {
        alert("No game in progress.");
        return;
      }
      try {
        const res = await fetch(`${SERVER_URL}/get_move`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ "game_id": gameId })
        });
        const data = await res.json();
        if (data.move === null) {
          alert("No move available (maybe checkmate?)");
          return;
        }
        if (data.error) {
          alert(data.error);
          return;
        }

        // 更新
        boardState = data.board;
        sideToMove = data.side_to_move;
        capturedPieces = data.captured_pieces ?? capturedPieces;

        sideToMoveSpan.textContent = sideToMove;
        renderCapturedPieces();
        renderBoard();
      } catch (err) {
        console.error(err);
        alert("Failed to get AI move.");
      }
    }

    async function applyMove(fromSq, toSq) {
      if (!gameId) {
        alert("No game in progress.");
        return;
      }
      try {
        const res = await fetch(`${SERVER_URL}/apply_move`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            "game_id": gameId,
            "from": fromSq,
            "to": toSq
          })
        });
        const data = await res.json();
        if (data.error) {
          alert(data.error);
          return;
        }
        if (data.success) {
          boardState = data.board;
          sideToMove = data.side_to_move;
          capturedPieces = data.captured_pieces ?? capturedPieces;

          sideToMoveSpan.textContent = sideToMove;
          renderCapturedPieces();
          renderBoard();
        }
      } catch (err) {
        console.error(err);
        alert("Failed to apply move.");
      }
    }

    async function fetchPossibleMoves(squareId) {
      if (!gameId) return [];
      try {
        const res = await fetch(`${SERVER_URL}/possible_moves`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ "game_id": gameId, "square": squareId })
        });
        const data = await res.json();
        if (data.error) {
          alert(data.error);
          return [];
        }
        return data.possible_moves || [];
      } catch (err) {
        console.error(err);
        return [];
      }
    }

    function renderBoard() {
      boardContainer.innerHTML = "";
      selectedSquare = null;
      possibleDestinations = [];

      const LEVELS = ["A", "B", "C", "D", "E"];
      const ROWS = ["5", "4", "3", "2", "1"];
      const COLS = ["a", "b", "c", "d", "e"];

      LEVELS.forEach(lvl => {
        const levelDiv = document.createElement("div");
        levelDiv.className = "level";

        const levelTitle = document.createElement("div");
        levelTitle.className = "level-title";
        levelTitle.textContent = `Level ${lvl}`;
        levelDiv.appendChild(levelTitle);

        ROWS.forEach(row => {
          const rowDiv = document.createElement("div");
          rowDiv.className = "row";
          COLS.forEach(col => {
            const squareId = lvl + col + row;
            const squareDiv = document.createElement("div");
            squareDiv.className = "square";
            squareDiv.id = squareId;
            squareDiv.textContent = boardState[squareId] || ".";

            squareDiv.addEventListener("click", () => onSquareClick(squareId));
            rowDiv.appendChild(squareDiv);
          });
          levelDiv.appendChild(rowDiv);
        });

        boardContainer.appendChild(levelDiv);
      });
    }

    async function onSquareClick(squareId) {
      // 移動元未選択なら
      if (!selectedSquare) {
        selectedSquare = squareId;
        highlightSquare(selectedSquare, "selected");

        // 可動マスを取得
        const moves = await fetchPossibleMoves(selectedSquare);
        possibleDestinations = moves;

        // ハイライト
        moves.forEach(sq => highlightSquare(sq, "possible-move"));
      } else {
        // すでに移動元がある状態
        const fromSq = selectedSquare;
        const toSq = squareId;

        unhighlightSquare(fromSq, "selected");
        possibleDestinations.forEach(sq => unhighlightSquare(sq, "possible-move"));
        selectedSquare = null;

        if (fromSq === toSq) {
          // 同じマスならキャンセル
          possibleDestinations = [];
          return;
        }

        if (possibleDestinations.includes(toSq)) {
          await applyMove(fromSq, toSq);
        }
        possibleDestinations = [];
      }
    }

    function highlightSquare(squareId, className) {
      const elem = document.getElementById(squareId);
      if (elem) elem.classList.add(className);
    }

    function unhighlightSquare(squareId, className) {
      const elem = document.getElementById(squareId);
      if (elem) elem.classList.remove(className);
    }

    // 追加: 捕獲リストを表示する
    function renderCapturedPieces() {
      // 例: whiteCapturedSpan.innerText = "Q,b,n" など
      whiteCapturedSpan.textContent = capturedPieces.white.join(" ");
      blackCapturedSpan.textContent = capturedPieces.black.join(" ");
    }

  </script>
</body>

</html>
